<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="野猪书读书笔记(第三章)"/>




  <meta name="keywords" content="读书笔记, 设计数据密集型应用, Lingering Fragments" />










  <link rel="alternate" href="/default" title="Lingering Fragments">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1" />



<link rel="canonical" href="https://pengye91.github.io/2018/10/18/野猪书读书笔记第三章/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1" />



  


<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-127442719-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-127442719-1');
</script>


  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>








<script>
  window.config = {"title":"Lingering Fragments","subtitle":"一些想法和总结","description":null,"author":"xyp","language":"zh-CN","timezone":"Asia/Shanghai","url":"https://pengye91.github.io","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":10,"pagination_dir":"page","theme":"even","deploy":{"type":"git","repo":"https://github.com/pengye91/pengye91.github.io.git","branch":"master"},"ignore":[],"keywords":null,"index_generator":{"per_page":10,"order_by":"-date","path":""},"sitemap":{"path":"sitemap.xml"},"baidusitemap":{"path":"baidusitemap.xml"},"archive_generator":{"per_page":10,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":10},"tag_generator":{"per_page":10},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"server":{"port":4000,"log":false,"compress":false,"header":true},"since":2018,"favicon":"/favicon.ico","rss":"default","menu":{"Home":"/","Archives":"/archives/","Tags":"/tags","Categories":"/categories","About":"/about"},"color":"cobalt blue","mode":"default","toc":true,"fancybox":true,"pjax":true,"copyright":{"enable":false,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>"},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"pengye91@gmail.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/pengye91","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"leancloud":{"app_id":null,"app_key":null},"baidu_analytics":null,"baidu_verification":null,"google_analytics":"UA-127442719-1","google_verification":null,"disqus_shortname":null,"valine":{"appid":"xeDhasO1xV7F1SpCG0oRuiol-gzGzoHsz","appkey":"wgFvo2YMOmn0Qcv7YPFxtePy","notify":false,"verify":false,"avatar":"identicon","visitor":true,"placeholder":"在此评论......"},"changyan":{"appid":null,"appkey":null},"livere_datauid":null,"version":"2.10.1"};
</script>

    <title> 野猪书读书笔记(第三章) - Lingering Fragments </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Lingering Fragments</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
      <a href="/tags">
        <li class="mobile-menu-item">
          
          
            标签
          
        </li>
      </a>
    
      <a href="/categories">
        <li class="mobile-menu-item">
          
          
            分类
          
        </li>
      </a>
    
      <a href="/about">
        <li class="mobile-menu-item">
          
          
            关于
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Lingering Fragments</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            
            
              标签
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            
            
              分类
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/about">
            
            
              关于
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          野猪书读书笔记(第三章)
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-10-18
        </span>
        
          <span class="post-category">
            
              <a href="/categories/数据/">数据</a>
            
              <a href="/categories/数据/设计数据密集型应用/">设计数据密集型应用</a>
            
          </span>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库的数据结构"><span class="toc-text">数据库的数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#log"><span class="toc-text">log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#index"><span class="toc-text">index</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#哈希索引-Hash-Indexes"><span class="toc-text">哈希索引(Hash Indexes)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排序字符串表（SSTables）和-LSM-树"><span class="toc-text">排序字符串表（SSTables）和 LSM-树</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#构建并维护-SSTables"><span class="toc-text">构建并维护 SSTables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从-SSTable-衍生出-LSM-tree"><span class="toc-text">从 SSTable 衍生出 LSM-tree</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能优化"><span class="toc-text">性能优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#小小结"><span class="toc-text">小小结</span></a></li></ol></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <center><img src="/images/designing-data-intensive-applications.png" alt=""></center>

<p><strong>存储和检索</strong></p>
<p>作为开发人员，我们需要选择合适自己应用的存储系统，为了做好性能调优，我们需要知道存储引擎底层做了啥。</p>
<a id="more"></a>
<h2 id="数据库的数据结构"><a href="#数据库的数据结构" class="headerlink" title="数据库的数据结构"></a>数据库的数据结构</h2><h3 id="log"><a href="#log" class="headerlink" title="log"></a>log</h3><p>许多数据库使用 <strong>log</strong> 来记录写操作。</p>
<p><strong>log</strong> 是一种 <strong>append-only</strong> 的数据文件。</p>
<p>如何避免 log 文件过大呢？<br>一种解决办法是：把日志切分成固定大小的小文件，并且对归档的 log 文件进行 <strong>压实（compaction）</strong>操作。</p>
<p><em>压实</em>意味着将重复的操作归类并且只保留最近更新的部分。同时，也可以将不同的小文件进行<em>压实</em>操作从而合并成一个文件。</p>
<h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><p>索引是一种从原始数据里派生出的<em>附加</em>的数据结构。</p>
<p>维护一份附加的数据结构通常会带来额外的性能开销，特别是在<strong>写</strong>的时候。任何类型的索引都会拖慢写操作，因为每次写操作都需要更新索引。</p>
<p>在存储系统中，这是一种重要的权衡:</p>
<p>设计良好的索引会提升读操作的速度，但是会拖慢写操作的速度。<br>因此，数据库不会默认给所有数据建立索引，而是要求开发人员自己根据应用类型决定索引的建立。</p>
<h2 id="哈希索引-Hash-Indexes"><a href="#哈希索引-Hash-Indexes" class="headerlink" title="哈希索引(Hash Indexes)"></a>哈希索引(Hash Indexes)</h2><p><strong>键值对</strong>数据索引非常常见，并且是很多复杂索引的基础。</p>
<p><strong>键值对</strong>存储和许多语言中的<em>字典</em>类型很相似，都是使用 Hash 表实现的。</p>
<p>哈希索引也同样遵循 log 文件的存储方式，每个分片文件都有自己的哈希表在内存中维护，当想要找到某个值时：</p>
<ul>
<li>首先，查找最近的分片文件的哈希表，如果没有找到，则找上一个分片文件的哈希表，以此类推直到找到。由于有<em>压实</em>策略，分片文件不会太多，因此性能问题不大。</li>
</ul>
<p>在现实世界中，有以下几点问题需要重点考虑：</p>
<ul>
<li><p>文件格式：<br><em>二进制</em>格式是理想的日志文件格式。</p>
</li>
<li><p>删除记录：<br>当删除一条记录时，需要<strong>向记录日志中添加一条特殊的删除记录</strong>，当<strong>压实</strong>开始时，合并操作会抛弃所以标记为删除的记录。</p>
</li>
<li><p>崩溃恢复<br>当数据库重启时，内存中的哈希表就丢失了。原则上，可以扫描所有的日志分片文件然后重新载入，但当文件数量比较大的时候会很慢。<br>一种做法是：为每个分片日志文件的哈希表保持一份快照，当重启数据库时，直接从快照恢复数据。</p>
</li>
<li><p>部分写记录<br>数据库随时都有可能崩溃，包括在半途添加记录时。一种办法时：添加 checksums 机制，当这种情况发生时会被检查到并被忽略。</p>
</li>
<li><p>并发控制<br>由于日志文件是被以严格的序列顺序写入的，一种常见的做法是：<strong>只有一个写线程</strong>。数据文件是只能追加的或者不可变的，所以被多个线程读是安全的。</p>
</li>
</ul>
<p><strong>只可追加（append-only）</strong>模式初看起来有点浪费：为何不更新旧值？有几个原因：</p>
<ul>
<li><strong>追加</strong>和<strong>文件合并</strong>都是序列写操作，这种操作比随机写要快得多，特别是在旋转磁盘上。对于SSD闪存硬盘来说，也会更快。</li>
<li><strong>并发</strong>和<strong>崩溃恢复</strong>会更简单。</li>
<li>合并旧的片段文件可以规避数据文件随着时间的增长变得碎片化的问题。</li>
</ul>
<p>然而，哈希索引也有下列<strong>限制</strong>：</p>
<ul>
<li><p>哈希表的大小必须小于系统内存。当然在原则上，你可以在硬盘上也维护一个哈希表，但硬盘上的随机写操作性能非常低下，另外，当哈希表过大时，为了避免哈希碰撞的代价是非常昂贵的。</p>
</li>
<li><p>范围查询将变得效率低下。</p>
</li>
</ul>
<h2 id="排序字符串表（SSTables）和-LSM-树"><a href="#排序字符串表（SSTables）和-LSM-树" class="headerlink" title="排序字符串表（SSTables）和 LSM-树"></a>排序字符串表（SSTables）和 LSM-树</h2><p>在<strong>哈希索引</strong>的基础上，对<em>键</em>做排序后再处理，就成了<em>排序字符串表(SSTables)</em>。</p>
<p>相比上面的哈希索引，<strong>SSTables</strong>有如下优点:</p>
<ol>
<li>使用类 <strong>合并排序</strong> 的思想，依次取每个小文件的最值到合并文件中，最后的合并文件就是<em>按键排序（sorted-by-key）</em>的文件。前提：总是合并相邻的小文件，所以当不同文件里有相同的 key 时，取最新文件中的值即可。</li>
<li>有序的作用在于：可以在内存中只保存少数键值对，由于所有的键值对都有序，很容易根据内存中的键值对在分片文件中找到想要的键值对。</li>
<li>由于读数据的请求需要扫描内存中的部分在查询范围内的键值对，因此可以将<em>SSTables文件中</em>的数据分块压缩成一块一块的条例，而在内存中维护的索引表的每一条都指向这些压缩块的头一条。</li>
</ol>
<h3 id="构建并维护-SSTables"><a href="#构建并维护-SSTables" class="headerlink" title="构建并维护 SSTables"></a>构建并维护 SSTables</h3><p>可以看到，构建 SSTable 的第一步是将数据按键排序。</p>
<p>在内存中维护一种有序的数据结构非常容易，可以使用包括红黑树或者平衡树之类的树形结构。</p>
<p>所以构建存储引擎可以按照如下的步骤：</p>
<ul>
<li>当有写操作请求时，首先将其加入内存中的平衡树。(内存中的平衡树有时被称为<em>内存表（memtable）</em>)</li>
<li>当内存表的大小大过某个阈值(通常是几 MB)后，内存表会以 SSTable 文件的形式存入硬盘，这个新的文件就成了数据库最新的分片文件，与此同时，内存中又有了新的内存表。</li>
<li>当有新的读操作时，首先查找内存表，然后是最新的硬盘上的分片文件，以此类推。</li>
<li>同时，另起一个线程合并分片文件。</li>
</ul>
<p>这种方式存在一个缺点：当数据库崩溃时，还没有写入磁盘的内存表的数据就彻底丢失了。为了解决这个问题，可以这样解决：</p>
<ul>
<li>单独在硬盘上维护一个<strong>只可追加</strong>日志文件</li>
<li>每当有写操作时，往这个文件最后追加一条记录</li>
<li>这个文件的数据是无序的，但是没关系，因为这个文件只是为了防止内存表中数据丢失而存在的</li>
<li>一旦内存表被写入 SSTable 文件，这个文件就可以被丢弃了。</li>
</ul>
<h3 id="从-SSTable-衍生出-LSM-tree"><a href="#从-SSTable-衍生出-LSM-tree" class="headerlink" title="从 SSTable 衍生出 LSM-tree"></a>从 SSTable 衍生出 LSM-tree</h3><p>使用上述<strong>合并压缩排序文件</strong>方法的存储引擎通常被称为 <strong>LSM(Log-Structured Merge-Tree)</strong> 存储引擎。</p>
<p>这种算法被用在了 <a href="https://github.com/google/leveldb" target="_blank" rel="noopener"><strong>LevelDB</strong></a> 和 <a href="https://github.com/facebook/rocksdb" target="_blank" rel="noopener"><strong>RocksDB</strong></a> 中。<br>相似的算法同样用在了 <strong>Cassandra</strong> 和 <strong>HBase</strong> 中，而这两个产品都受 <strong>Google Bigtable</strong> 论文的启发，另外，<em>SSTable</em> 和 <em>memtable</em> 同样是出自 <em>Bigtable</em> 论文。</p>
<p>Lucene 也采用了相似的思路来存储 <strong>term dictionary</strong>。其中，key 是 term，value 是 包含 term 的文档 ID 列表(postings list)。</p>
<h3 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h3><p>LSM-Tree 算法的性能优化可以从以下几个方面着手：</p>
<ul>
<li>引入 <strong>布隆过滤器(Bloom Filter)</strong>。 当想要寻找的 Key 在数据库中不存在时，性能会很低下：因为数据库会尝试从 memtable 一直查询到最旧的 SStable 文件。一种解决办法是：引入布隆过滤器，在查询之前先询问是否有这个 Key。</li>
<li>选择<strong>合适的合并压实策略</strong>。常见的策略有 <em>size-tiered</em> 和 <em>leveled</em> 压实策略。</li>
</ul>
<h3 id="小小结"><a href="#小小结" class="headerlink" title="小小结"></a>小小结</h3><p>LSM-tree 是一种简洁但是非常高效的算法。即使数据集非常庞大，也能正常工作而且工作得很好。由于键是排好序的，范围查找也很高效。同时，由于分片文件都是序列写入硬盘的，LSM-tree 可以提供异常高的写入吞吐量。</p>
<p>(To be continued…)</p>

      
    </div>

    
      
      



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/读书笔记/">读书笔记</a>
            
              <a href="/tags/设计数据密集型应用/">设计数据密集型应用</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/10/20/野猪书读书笔记第三章续1/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">野猪书读书笔记第三章(续一)</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2018/10/16/构建数据仓库概念和工具一/">
        <span class="next-text nav-default">构建数据仓库概念和工具一</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="vcomments"></div>
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:pengye91@gmail.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/pengye91" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">xyp</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  
<!-- valine Comments -->
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.3.3/dist/Valine.min.js"></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments',
        notify: false,
        verify: false,
        visitor: true,
        app_id: "xeDhasO1xV7F1SpCG0oRuiol-gzGzoHsz",
        app_key: "wgFvo2YMOmn0Qcv7YPFxtePy",
        placeholder: "在此评论......",
        avatar: 'identicon'
    });
</script>


  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
